<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        城市云卡-交易明细
    </title>
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/transitIndex.css">
</head>

<body>
    <div class="layui-fluid">
        <!-- 顶部返回与标题 -->
        <div class="layui-row transitContent">
            <h2 class="transitTitle">
                <a href="javascript:;" class="back ofenBack">
                    <i class="layui-icon layui-icon-left">
                    </i>
                    返回
                </a>
                交易明细
            </h2>
        </div>
        <!-- 顶部返回与标题end -->
        <!-- 交易明细tab切换 -->
        <div class="layui-row cardDetails">
            <div class="layui-tab layui-tab-brief" lay-filter="cardDetails">
                <ul class="layui-tab-title">
                    <li class="layui-this">
                        全部
                    </li>
                    <li>
                        充值
                    </li>
                    <li>
                        消费
                    </li>
                </ul>
                <div class="layui-tab-content mescroll" id="mescroll">
                    <div class="layui-tab-item allDetail layui-show">
                        <div class="layui-row seachDetail">
                            <div class="layui-col-xs2">
                                本月
                            </div>
                            <div class="layui-col-xs2 layui-col-xs-offset8">
                                <i class="layui-icon layui-icon-date seachTime" index='0'></i>
                            </div>
                            <div class="layui-col-xs12 seachHelp">
                                说明: 由于网络原因,数据可能会有延迟
                            </div>
                        </div>
                        <div class="seachContent">

                        </div>
                    </div>
                    <div class="layui-tab-item rechargeDetail">
                        <div class="layui-row seachDetail">
                            <div class="layui-col-xs2">
                                本月
                            </div>
                            <div class="layui-col-xs2 layui-col-xs-offset8">
                                <i class="layui-icon layui-icon-date seachTime" index='1'></i>
                            </div>
                            <div class="layui-col-xs12 seachHelp">
                                说明: 由于网络原因,数据可能会有延迟
                            </div>
                        </div>
                        <div class="seachContent">

                        </div>
                    </div>
                    <div class="layui-tab-item consumeDetail">
                        <div class="layui-row seachDetail">
                            <div class="layui-col-xs2">
                                本月
                            </div>
                            <div class="layui-col-xs2 layui-col-xs-offset8">
                                <i class="layui-icon layui-icon-date seachTime" index='2'></i>
                            </div>
                            <div class="layui-col-xs12 seachHelp">
                                说明: 由于网络原因,数据可能会有延迟
                            </div>
                        </div>
                        <div class="seachContent">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 交易明细end -->

    </div>
    <!-- 隐藏域 -->
    <input type="hidden" id="hiddenData" value="">
    <input type="hidden" id="hiddenData2" value="">
</body>
<script src="../../js/jquery-3.3.1.min.js"></script>
<script src="../../js/jquery.base64.js"></script>
<script src="../../js/url.js"></script>
<script src="../../js/getparameter.js"></script>
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery.selector-px.js"></script>
<script src="../../js/mescroll.min.js"></script>
<script id="seachContent" type="text/html">
        {{#layui.each(d.value,function(index, item) {}}
        <div class="layui-row seachContentBox">
            <div class="layui-col-xs9">
                <!-- {{# if(item.txntype == '2'){ }} -->
                    <p class="detailsType">消费</p>
                <!-- {{# }else if(item.txntype == '3'){ }} -->
                    <!-- <p class="detailsType">充值</p> -->
                <!-- {{# } }} -->
                <p class="detailsTime">{{ item.opdt }}</p>
                <p class="detailsNum">订单编号: <span>{{ item.txnid }}</span></p>
            </div>
            <div class="layui-col-xs3">
                <p class="detailsMoney">{{ item.opfare }}</p>
                {{# if(item.detailsStatus == '已领款'){ }}
                    <p class="detailsStatus" style="color: #4889EF;">{{ item.detailsStatus }}</p>
                {{# }else{ }}
                    <p class="detailsStatus">{{ item.detailsStatus }}</p>
                {{# } }}
            </div>
        </div>
        {{# }); }}
    </script>
<script>
    //获取url参数
    $(document).ready(function () {
        var a = GetRequest();
        var cardid = a['cardid'];   //公交卡id
        var authorization = a['authorization'];   //公交卡id
        // console.log(cardid);
        // console.log(authorization);

        layui.use(['form', 'layer', 'element', 'laytpl'],
            function () {
                var form = layui.form,
                    layer = layui.layer,
                    element = layui.element,
                    laytpl = layui.laytpl;

                //返回按钮
                $(".ofenBack").on("click",
                    function () {
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index); //再执行关闭
                    });

                //tab一些事件监听
                element.on('tab(cardDetails)', function (data) {
                    console.log(data);
                });

                //获取当月第一天和现在的日期
                var newDay = new Date();
                var year = newDay.getFullYear();
                var month = newDay.getMonth() + 1;
                var nowday = newDay.getDate();
                month = month < 10 ? '0' + month : month;
                var firstdate = year + '-' + month + '-' + '01';
                var lastdate = year + '-' + month + '-' + nowday;
                console.log(firstdate);
                console.log(lastdate);

                //下拉加载
                // var mescroll = new MeScroll("mescroll", {    //创建MeScroll对象
                //     up: {
                //         callback: upCallback, //上拉加载的回调
                //         page: {
                //             num: 0, //当前页 默认0,回调之前会加1; 即callback(page)会从1开始
                //             size: 10 //每页数据条数,默认10
                //         },
                //         htmlNodata: '<p class="upwarp-nodata">-- END --</p>',
                //         noMoreSize: 5, //如果列表已无数据,可设置列表的总数量要大于5才显示无更多数据;
                //         toTop: {
                //             //回到顶部按钮
                //             src: "../../img/mescroll-totop.png", //图片路径,默认null,支持网络图
                //             offset: 1000 //列表滚动1000px才显示回到顶部按钮	
                //         }
                //     }
                // });

                //请求充值消费记录接口
                // function upCallback(page) {   //上拉加载
                $.ajax({
                    url: globalurl + '/appbus/getBusTransactionDetails',
                    type: 'post',
                    data: {
                        cardno: '530000010000AFEE',
                        merCode: '10003',
                        strdate: '2011-11-11',
                        enddate: '2018-11-11',
                        pageno: '1',
                        txntype: '0'
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == "0000") {
                            var value = JSON.parse($.base64.decode(res.data));   //base64解密
                            console.log(value);
                            // var getTpl = seachContent.innerHTML;
                            // var view = document.getElementById('seachContent');
                            // laytpl(getTpl).render(res, function (html) {
                            //     view.innerHTML = html;
                            // });
                            if (value[i].txntype == 0) {
                                var seachContentHtml = $("#seachContent").html();
                                laytpl(seachContentHtml).render(res, function (html) {
                                    $(".allDetail").find(".seachContent").html(html);
                                });
                            }
                            function elementInit(res) {
                                var seachContentHtml = $("#seachContent").html();
                                laytpl(seachContentHtml).render(res, function (html) {
                                    $(".allDetail").find(".seachContent").html(html);
                                });
                                // mescroll.endByPage(res.data.length, res.data.totalPage);
                                // page++;
                                //区分充值记录与消费记录并重新渲染
                                var newData1 = {}, newData2 = {}, newArr1 = [], newArr2 = [];
                                newData1.value = newArr1;
                                newData2.value = newArr2;
                                for (var i = 0; i < value.length; i++) {
                                    if (value[i].txntype == 3) {
                                        newArr1.push(value[i]);
                                    } else if (value[i].txntype == 2) {
                                        newArr2.push(value[i]);
                                    }
                                }
                                //渲染充值记录
                                laytpl(seachContentHtml).render(newData1, function (html) {
                                    $(".rechargeDetail").find(".seachContent").html(html);
                                });
                                //渲染消费记录
                                laytpl(seachContentHtml).render(newData2, function (html) {
                                    $(".consumeDetail").find(".seachContent").html(html);
                                });
                            }
                            elementInit(res.data);
                        } else {
                            layer.msg(res.msg);
                        }

                    },
                    error: function () {
                        layer.msg("请求数据失败!");
                        // mescroll.endErr();
                    }
                });
                // }

                var res = '';
                $(".seachTime").each(function () {
                    var $this = $(this);
                    var thisIndex = $this.attr("index");
                    $this.on("click", function () {
                        layer.open({
                            type: 2,
                            closeBtn: 0,
                            title: false,
                            content: 'seachTimeDetailsMonth.html?thisIndex=' + thisIndex,
                            area: ['100%', '100%'],
                            yes: function (index) {
                                layer.close(index);
                            },
                            end: function () {
                                console.log($("#hiddenData").val());
                                console.log($("#hiddenData2").val());
                                elementInit(JSON.parse($("#hiddenData2").val()));
                            }
                        });
                    });

                });
            });
    });
</script>

</html>