<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账单</title>
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/schooltransitIndex.css">
</head>
<body style="background:#fff;">
<div class="layui-fluid">
    <!-- 顶部返回与标题 -->
    <div class="layui-row transitContent">
        <h2 class="transitTitle">
            <a href="javascript:;" class="back ofenBack">
                <i class="layui-icon layui-icon-left">
                </i>
                返回
            </a>
            交易明细
        </h2>
    </div>
    <!-- 顶部返回与标题end -->
    <!-- 交易明细tab切换 -->
    <div class="layui-row cardDetails">
        <div class="layui-tab layui-tab-brief" lay-filter="test1">
            <ul class="layui-tab-title">
                <li class="layui-this" lay-id="111">全部</li>
                <li lay-id="222">充值</li>
                <li lay-id="333">消费</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item allDetail layui-show">
                    <div class="layui-row seachDetail">
                        <div class="layui-col-xs2">本月</div>
                        <div class="layui-col-xs2 layui-col-xs-offset8">
                            <i class="layui-icon layui-icon-date seachTime" index='0'></i>
                        </div>
                        <div class="layui-col-xs12 seachHelp">
                            说明: 由于网络原因,数据可能会有延迟
                        </div>
                    </div>
                    <div class="seachContent seachContent_1">
                                            
                    </div>
                </div>
                <div class="layui-tab-item rechargeDetail">
                    <div class="layui-row seachDetail">
                        <div class="layui-col-xs2">
                            本月
                        </div>
                        <div class="layui-col-xs2 layui-col-xs-offset8">
                            <i class="layui-icon layui-icon-date seachTime" index='1'></i>
                        </div>
                        <div class="layui-col-xs12 seachHelp">
                            说明: 由于网络原因,数据可能会有延迟
                        </div>
                    </div>
                    <div class="seachContent seachContent_2">
                        
                    </div>
                </div>
                <div class="layui-tab-item consumeDetail">
                    <div class="layui-row seachDetail">
                        <div class="layui-col-xs2">
                            本月
                        </div>
                        <div class="layui-col-xs2 layui-col-xs-offset8">
                            <i class="layui-icon layui-icon-date seachTime" index='2'></i>
                        </div>
                        <div class="layui-col-xs12 seachHelp">
                            说明: 由于网络原因,数据可能会有延迟
                        </div>
                    </div>
                    <div class="seachContent seachContent_3">
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 交易明细end -->

</div>
<!-- 隐藏域 -->
<input type="hidden" id="hiddenData" value="">
<input type="hidden" id="hiddenData2" value="">
</body>
<script src="../../js/jquery-3.3.1.min.js"></script>
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery.selector-px.js"></script>
<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
<script>

    layui.use(['form', 'layer', 'element', 'laytpl'], function () {
        var form = layui.form,
            layer = layui.layer,
            element = layui.element,
            laytpl = layui.laytpl;

        var layid = $.getQueryString("layid");
        element.tabChange('test1', layid);


        element.on('tab(test1)', function (data) {
            layid = this.getAttribute('lay-id');
        });


        //返回按钮
        $(".ofenBack").on("click",
            function () {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            });


        $(".seachTime").click(function () {
            console.log($(this).attr("index"));
            layer.open({
                type: 2,
                closeBtn: 0,
                title: false,
                content: 'aMonth.html?layid=' + layid,
                area: ['100%', '100%'],
                yes: function (index) {
                    layer.close(index);
                },
            });
        });
        //时间戳转换
		function getMyDate(str){  
            var oDate = new Date(str),  
            oYear = oDate.getFullYear(),  
            oMonth = oDate.getMonth()+1,  
            oDay = oDate.getDate(),  
            oHour = oDate.getHours(),  
            oMin = oDate.getMinutes(),  
            oSen = oDate.getSeconds(),  
//          oTime = oYear +'-'+ getzf(oMonth) +'-'+ getzf(oDay) +' '+ getzf(oHour) +':'+ getzf(oMin) +':'+getzf(oSen);
            oTime = getzf(oMonth) +'月'+ getzf(oDay) +'日 '+ getzf(oHour) +':'+ getzf(oMin) +':'+getzf(oSen);
            return oTime;  
        }; 
        function getzf(num){  
          	if(parseInt(num) < 10){  
              	num = '0'+num;  
          	}  
          	return num;  
      	};        
        var newStratDate = localStorage.getItem('startTime')
        var newEndDate = localStorage.getItem('endTime')
        console.log('选择时间后的开始时间********',newStratDate)
        console.log('选择时间后的结束时间********',newEndDate)        
        //获取当月第一天和最后一天
        var newDay = new Date();  
		var year = newDay.getFullYear();  
		var month = newDay.getMonth() + 1;  
		var day = new Date(year,month,0); 
		month =  month < 10 ? '0' + month : month;
		var firstdate = year +  month + '01' ; 
		var lastdate = year +  month +  day.getDate();  
		if (newStratDate == null) {
			//全部接口
			$.ajax({
				type:"post",
				url:"http://1.192.121.127:12613/gateway/bill/allList",
				data:{
					startDate:firstdate,
					endDate:lastdate,
					pageNum:1
				},
	        	async:true,
	        	dataType: 'json',
	        	success:function(success){
	        		console.log(success);
					var data = success.data;
					var html_all = '';
					for (var i=0;i<success.data.length;i++) {
						html_all += '<div class="layui-row seachContentBox">';	
		                html_all += '<div class="layui-col-xs9">'; 
		                if (data[i].way == null) {
		                	html_all += '<p class="detailsType">消费</p>';  
		                } else{
		                	html_all += '<p class="detailsType">'+ data[i].way +'</p>';  
		                }		                                             
		                html_all += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';   
		                if (data[i].flag == 0) {
		                	html_all += '<p class="detailsNum">订单编号: <span>'+ data[i].outTradeNo +'</span></p>';    
		                } else{
		                	html_all += '<p class="detailsNum">线路: <span>198</span></p>';    
		                }
		               	           
		                html_all += '</div>';          
		                html_all += '<div class="layui-col-xs3">';     
		                if (data[i].flag == 0) {
		                	 html_all += '<p class="detailsMoney">'+ '+' + data[i].money +'</p>';     
		                } else{
		                	 html_all += '<p class="detailsMoney">'+ '-' + data[i].money +'</p>';     
		                }
		                        
		                html_all += '<p class="detailsStatus">待领取</p>';                
		                html_all += '</div>';            
		                html_all += '</div>';        
					}
					$('.seachContent_1').html(html_all)
	        	}
			});
			//充值接口
			$.ajax({
	        	type:"post",
	        	url:"http://1.192.121.127:12613/gateway/bill/rechargeList",
	        	data:{
					startDate:firstdate,
					endDate:lastdate,
					pageNum:1
				},
	        	async:true,
	        	dataType: 'json',
	        	success:function(success){
	        		console.log(success);
					var data = success.data;
					var html_cz = '';
					for (var i=0;i<success.data.length;i++) {
						html_cz += '<div class="layui-row seachContentBox">';	
		                html_cz += '<div class="layui-col-xs9">';       
		                html_cz += '<p class="detailsType">'+ data[i].way +'</p>';                               
		                html_cz += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';               
		               	html_cz += '<p class="detailsNum">订单编号: <span>'+ data[i].outTradeNo +'</span></p>';               
		                html_cz += '</div>';          
		                html_cz += '<div class="layui-col-xs3">';          
		                html_cz += '<p class="detailsMoney">'+ '+' + data[i].money +'</p>';              
		                html_cz += '<p class="detailsStatus">待领取</p>';                
		                html_cz += '</div>';            
		                html_cz += '</div>';        
					}
					$('.seachContent_2').html(html_cz)
	        	}
	        });
	        //消费接口
			$.ajax({
				type:"post",
				url:"http://1.192.121.127:12613/gateway/bill/consumptionList",
				data:{
					startDate:firstdate,
					endDate:lastdate,
					pageNum:1
				},
				async:true,
				dataType: 'json',
				success:function(success){
					var data = success.data;
					var html_xf = '';
					for (var i=0;i<success.data.length;i++) {
						html_xf += '<div class="layui-row seachContentBox">';	
		                html_xf += '<div class="layui-col-xs9">';       
		                if (data[i].way == null) {
		                	html_xf += '<p class="detailsType">消费</p>';  
		                } else{
		                	html_xf += '<p class="detailsType">'+ data[i].way +'</p>';  
		                }	                              
		                html_xf += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';               
		               	html_xf += '<p class="detailsNum">线路: <span>198</span></p>';               
		                html_xf += '</div>';          
		                html_xf += '<div class="layui-col-xs3">';          
		                html_xf += '<p class="detailsMoney">'+ '-' + data[i].money +'</p>';              
		                html_xf += '<p class="detailsStatus">待领取</p>';                
		                html_xf += '</div>';            
		                html_xf += '</div>';        
					}
					$('.seachContent_3').html(html_xf)
				}
			});
		} else{
			//全部接口
			$.ajax({
				type:"post",
				url:"http://1.192.121.127:12613/gateway/bill/allList",
				data:{
					startDate:newStratDate,
					endDate:newEndDate,
					pageNum:1
				},
	        	async:true,
	        	dataType: 'json',
	        	success:function(success){
	        		console.log(success);
					var data = success.data;
					var html_all = '';
					for (var i=0;i<success.data.length;i++) {
						html_all += '<div class="layui-row seachContentBox">';	
		                html_all += '<div class="layui-col-xs9">'; 
		                if (data[i].way == null) {
		                	html_all += '<p class="detailsType">消费</p>';  
		                } else{
		                	html_all += '<p class="detailsType">'+ data[i].way +'</p>';  
		                }		                                             
		                html_all += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';
		                if (data[i].flag == 0) {
		                	html_all += '<p class="detailsNum">订单编号: <span>'+ data[i].outTradeNo +'</span></p>';    
		                } else{
		                	html_all += '<p class="detailsNum">线路: <span>198</span></p>';    
		                }
		               	           
		                html_all += '</div>';          
		                html_all += '<div class="layui-col-xs3">';     
		                if (data[i].flag == 0) {
		                	 html_all += '<p class="detailsMoney">'+ '+' + data[i].money +'</p>';     
		                } else{
		                	 html_all += '<p class="detailsMoney">'+ '-' + data[i].money +'</p>';     
		                }
		                        
		                html_all += '<p class="detailsStatus">待领取</p>';                
		                html_all += '</div>';            
		                html_all += '</div>';        
					}
					$('.seachContent_1').html(html_all)
	        	}
			});
			//充值接口
			$.ajax({
	        	type:"post",
	        	url:"http://1.192.121.127:12613/gateway/bill/rechargeList",
	        	data:{
					startDate:newStratDate,
					endDate:newEndDate,
					pageNum:1
				},
	        	async:true,
	        	dataType: 'json',
	        	success:function(success){
	        		console.log(success);
					var data = success.data;
					var html_cz = '';
					for (var i=0;i<success.data.length;i++) {
						html_cz += '<div class="layui-row seachContentBox">';	
		                html_cz += '<div class="layui-col-xs9">';       
		                html_cz += '<p class="detailsType">'+ data[i].way +'</p>';                               
		                html_cz += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';               
		               	html_cz += '<p class="detailsNum">订单编号: <span>'+ data[i].outTradeNo +'</span></p>';               
		                html_cz += '</div>';          
		                html_cz += '<div class="layui-col-xs3">';          
		                html_cz += '<p class="detailsMoney">'+ '+' + data[i].money +'</p>';              
		                html_cz += '<p class="detailsStatus">待领取</p>';                
		                html_cz += '</div>';            
		                html_cz += '</div>';        
					}
					$('.seachContent_2').html(html_cz)
	        	}
	        });
	        //消费接口
			$.ajax({
				type:"post",
				url:"http://1.192.121.127:12613/gateway/bill/consumptionList",
				data:{
					startDate:newStratDate,
					endDate:newEndDate,
					pageNum:1
				},
				async:true,
				dataType: 'json',
				success:function(success){
					var data = success.data;
					var html_xf = '';
					for (var i=0;i<success.data.length;i++) {
						html_xf += '<div class="layui-row seachContentBox">';	
		                html_xf += '<div class="layui-col-xs9">';       
		                if (data[i].way == null) {
		                	html_xf += '<p class="detailsType">消费</p>';  
		                } else{
		                	html_xf += '<p class="detailsType">'+ data[i].way +'</p>';  
		                }		                              
		                html_xf += '<p class="detailsTime" value="'+ data[i].id +'" data_flag="'+ data[i].flag +'">'+ getMyDate(data[i].paytime) +'</p>';               
		               	html_xf += '<p class="detailsNum">线路: <span>198</span></p>';               
		                html_xf += '</div>';          
		                html_xf += '<div class="layui-col-xs3">';          
		                html_xf += '<p class="detailsMoney">'+ '-' + data[i].money +'</p>';              
		                html_xf += '<p class="detailsStatus">待领取</p>';                
		                html_xf += '</div>';            
		                html_xf += '</div>';        
					}
					$('.seachContent_3').html(html_xf)
				}
			});
		}
       
		//消费
		$('.seachContent').on('click','.seachContentBox',function(){
			var money = $(this).find(".detailsMoney").html();
			var route = $(this).find('.detailsNum span').html();
			var billId = $(this).find('.detailsTime').attr('value');
			var data_flag = $(this).find('.detailsTime').attr('data_flag');
			localStorage.setItem('money',money);
			localStorage.setItem('route',route);
			localStorage.setItem('billId',billId);
			
			console.log("***********",data_flag)
			if (data_flag == 0) {
				layer.open({
	                type: 2,
	                closeBtn: 0,
	                title: false,
	                content: 'consumerechargeDetails.html?money=' + money + '&route=' + route + '&billId=' + billId,
	                area: ['100%', '100%'],
	                yes: function (index) {
	                    layer.close(index);
	                },
	            });
			} else{
				layer.open({
	                type: 2,
	                closeBtn: 0,
	                title: false,
	                content: 'rechargeDetails.html?money=' + money + '&route=' + route + '&billId=' + billId,
	                area: ['100%', '100%'],
	                yes: function (index) {
	                    layer.close(index);
	                },
	            });
			} 
		});
		localStorage.clear('newStratDate');
		localStorage.clear('newEndDate')
    });
</script>

</html>